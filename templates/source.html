{% extends "base.html" %}

{% block content %}

<div id="top">

  <header>
    <h1 class="logo_container">
      <img class="logo" src="/static/favicon.svg" alt="logo">
      <a href="/" class="icon_logo">Elephant<span>.ai</span></a>
    </h1>
    <a href="#mainMenu" class="openMainMenu" hidden></a>
    <nav id="mainMenu">
      <a href="#" class="modalClose" hidden></a>
      <ul>
        <li hidden><a href="#" class="modalClose">Exit Menu</a></li>
        <li><a href="/dashboard">Dashboard</a></li>
        <li class="alternate featured"><a href="/user/signout">Sign Out</a></li>
        <li class="alternate username">{{user.name}}</li>
      </ul>
    </nav>
  </header>

  <main>

    <section id="testimonials">
      <header id="accountDetails">
        <h2>{{source['bot_name']}}</h2>
        <h3>{{source['domain_name']}}</h3>
        <br><br>
        <p>
          {% if source.ifBotId is none %}
            We detected <strong>{{source.urls|length}}</strong> URLs on the Sitemap.<br>
            You can add new URLs and delete the unwanted ones.<br>
            Proceed with the urls that you want to train your Chatbot on.<br>
            Your plan supports a maximum of <strong>{{source['limit']}}</strong> URLs.<br>
          {% else %}
            We detected <strong>{{source.urls|length}}</strong> NEW URLs on the Sitemap.<br>
            You can add new URLs and delete the unwanted ones.<br>
            Proceed with the urls that you want to add to {{source.bot_name}}<br>
            Your plan supports a maximum of <strong>{{source['limit']}}</strong> additional URLs.<br>
          {% endif %}
        </p><br>

        <section class="source_container">
          <h3>Available URLs</h3>
          <div class="pagination-row">
            <div>
              <label>URLs per page: </label>
              <select id="pagination-dropdown">
                <option value="10">10</option>
                <option value="20">20</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
            </div>        
            <div id="pagination">
              <!-- Pagination will be generated by JavaScript -->
            </div>
          </div>
          <table id="url-table" class="source_table">
            <!-- Table content will be generated by JavaScript -->
          </table>
          
          <p id="source_select_err" class="error error--hidden"></p>
          <div class="button-row">
            <button id="delete-btn">Delete</button>
            <button id="proceed-btn">Proceed</button>
          </div>
        </section>
        <br>

        <section>
          <h3>Enter New URLs (New Line Separated)</h3>
          <form class="onPageForm"  name="source_add_form" data-id="{{source['_id']}}">
            <p id="source_add_err" class="error error--hidden"></p>
            <fieldset>
            <input type="hidden" name="csrf_token" value={{csrf_token}}>
            <textarea name="urls" rows="5" width="60%" resize="vertical"></textarea>
            </fieldset>
            <footer>
              <button type="submit">Add</button>
            </footer>
          </form>
        </section>
        <br>
        
      </header>
    <!-- #testimonials --></section>

  </main>

  <footer>
    <div class="logo_container logo_footer">
      <img class="logo" src="/static/favicon.mask.svg" alt="logo">
      <a href="/" class="icon_logo">Elephant<span>.ai</span></a>
    </div>
    <ul class="onPageLinks">
        <li><a href="#testimonials">Details</a></li>
        <li><a href="#pricing">Subscribe</a></li>
        <li><a href="/dashboard">Dashboard</a></li>
    </ul>
    <p>
      &copy; 2023 Elephant.ai All rights reserved.
    </p>
    <ul class="socialLinks">
      <li>
        <a href="#" class="icon_twitter">
          <span>Twitter</span>
        </a>
      </li><li>
        <a href="#" class="icon_github">
          <span>Github</span>
        </a>
      </li>
    </ul>
  </footer>

</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const urlTable = document.getElementById("url-table");
    const proceedBtn = document.getElementById("proceed-btn");
    const deleteBtn = document.getElementById("delete-btn");
    const shortlistedUrls = document.getElementById("shortlisted-urls");
    const pagination = document.getElementById("pagination");
    const dropdown = document.getElementById("pagination-dropdown");
    const urlList = generateUrls();
    let urlsPerPage = 10;
    let currentPage = 1;
    let selectedUrls = new Set();

    displayUrls();
    displayPagination();

    // Generate URLs
    function generateUrls() {
      const urldict = JSON.parse(`{{source.urls|tojson}}`);
      const urls = Object.values(urldict);
      return urls;
    }

    // Display URLs with pagination
    function displayUrls() {
      const startIndex = (currentPage - 1) * urlsPerPage;
      const endIndex = startIndex + urlsPerPage;
      const urlsToDisplay = urlList.slice(startIndex, endIndex);

      let tableContent = `<tr>  <th id="select-all-label">Select All</th> <th><input type="checkbox" id="select-all"></th>  </tr>`;

      urlsToDisplay.forEach((url) => {
        const isSelected = selectedUrls.has(url.index.toString());
        tableContent += `
    <tr class="source_link_row">
      <td class="source_link_text">${url.url}</td>
      <td><input type="checkbox" class="url-checkbox source_action" data-index="${url.index}" ${
          isSelected ? "checked" : ""
        }></td>
    </tr>
  `;
      });
      urlTable.innerHTML = tableContent;
      addCheckboxListeners();
    }

    // Display pagination
    function displayPagination() {
      const pageCount = Math.ceil(urlList.length / urlsPerPage);
      let paginationContent = "";

      for (let i = 1; i <= pageCount; i++) {
        paginationContent += `<button class="pagination-btn${
          i === currentPage ? " current-page" : ""
        }" data-page="${i}">${i}</button>`;
      }

      pagination.innerHTML = paginationContent;
      addPaginationListeners();
    }

    // Checkbox event listeners
    function addCheckboxListeners() {
      const selectAllCheckbox = document.getElementById("select-all");
      const urlCheckboxes = document.querySelectorAll(".url-checkbox");

      selectAllCheckbox.addEventListener("change", function () {
        const isChecked = this.checked;
        urlCheckboxes.forEach((checkbox) => {
          const url = checkbox.getAttribute("data-index");
          checkbox.checked = isChecked;
          if (isChecked) {
            selectedUrls.add(url);
          } else {
            selectedUrls.delete(url);
          }
        });
      });

      urlCheckboxes.forEach((checkbox) => {
        checkbox.addEventListener("change", function () {
          const url = this.getAttribute("data-index");
          if (this.checked) {
            selectedUrls.add(url);
          } else {
            selectedUrls.delete(url);
          }
          selectAllCheckbox.checked = selectedUrls.size === urlList.length;
        });
      });
    }

    // Pagination event listeners
    function addPaginationListeners() {
      const paginationBtns = document.querySelectorAll(".pagination-btn");

      paginationBtns.forEach((btn) => {
        btn.addEventListener("click", function () {
          currentPage = parseInt(this.getAttribute("data-page"));
          displayUrls();
          displayPagination();
        });
      });

      dropdown.addEventListener("change", function(event) {
        urlsPerPage = parseInt(event.target.value);
        currentPage = 1;
        displayUrls();
        displayPagination();
      });
    }
    

    // Proceed button click event
    proceedBtn.addEventListener("click", function () {
      const csrf = "{{csrf_token}}"
      const data = { indexes: [...selectedUrls] }
      var $error = $("#source_select_err")
      $.ajax({
          type: 'post',
          url: '/source/select?id={{source._id}}',
          headers:{
            "X-CSRF-TOKEN":csrf
          },
          data: JSON.stringify(data),
          contentType: "application/json; charset=utf-8",
          traditional: true,
          success: function(data) {
            // Redirect to a new page on successful API call
            window.location.href = "/sourceselected?id={{source._id}}";
          },
          error: function(resp) {
            $error.text(resp.responseJSON.error).removeClass("error--hidden");
            setTimeout(()=>{
              $error.text("").addClass("error--hidden");
            }, 5000)
          }
      });
    });

    deleteBtn.addEventListener("click", function () {
      const csrf = "{{csrf_token}}"
      const data = { indexes: [...selectedUrls] }
      var $error = $("#source_select_err")
      $.ajax({
          type: 'post',
          url: '/source/delete?id={{source._id}}',
          headers:{
            "X-CSRF-TOKEN":csrf
          },
          data: JSON.stringify(data),
          contentType: "application/json; charset=utf-8",
          traditional: true,
          success: function(data) {
            // Redirect to a new page on successful API call
            document.location.reload();
          },
          error: function(resp) {
            $error.text(resp.responseJSON.error).removeClass("error--hidden");
            setTimeout(()=>{
              $error.text("").addClass("error--hidden");
            }, 5000)
          }
      });
    });

  });
</script>

{% endblock %}